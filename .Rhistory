dim(array_obs_reflectance)
Data <- list(obs_reflectance = cbind(data.spectra_T_PNM,
data.spectra_T_FTS,
data.spectra_L_PNM,
data.spectra_L_FTS))
dim(Data$obs_reflectance)
Delta_WL
2101/50
pos
data.spectra
cccdata %>% filter(name == 1) %>% filter(wv %in% WLs) %>% arrange(wv) %>% pull(value)
length(cccdata %>% filter(name == 1) %>% filter(wv %in% WLs) %>% arrange(wv) %>% pull(value))
dim(array_obs_reflectance)
data.spectra_T_PNM
data.spectra_T_PNM <- data.spectra %>% filter(GF == "Tree",
site == "PNM") %>%
group_by(wv) %>% summarise(value = mean(value),
.groups = "drop") %>% dplyr::select(value)
data.spectra_T_PNM
data.spectra
data.spectra <- readRDS("./data/All.spectra.ID.RDS") %>%
group_by(GF,site,Species) %>% mutate(species.id = cur_group_id()) %>% group_by(GF,site) %>% mutate(species.id = species.id - min(species.id) + 1) %>%
group_by(GF,site,species.id,Ind) %>% mutate(ind.id = cur_group_id()) %>% group_by(GF,site,species.id) %>% mutate(ind.id = ind.id - min(ind.id) + 1) %>%
group_by(GF,site,species.id,ind.id,name) %>% mutate(leaf.id = cur_group_id()) %>% group_by(GF,site,species.id,ind.id) %>% mutate(leaf.id = leaf.id - min(leaf.id) + 1) %>%
mutate(value2 = value,
value = case_when(wv %in% c(400:680,800:2500) ~ value,
TRUE ~ NA_real_))
data.spectra_T_PNM <- data.spectra %>% filter(GF == "Tree",
site == "PNM",
wv %in% WLs) %>%
group_by(wv) %>% summarise(value = mean(value),
.groups = "drop") %>% dplyr::select(value)
data.spectra_T_FTS <- data.spectra %>% filter(GF == "Tree",
site == "FTS",
wv %in% WLs) %>%
group_by(wv) %>% summarise(value = mean(value),
.groups = "drop") %>% dplyr::select(value)
data.spectra_L_PNM <- data.spectra %>% filter(GF == "Liana",
site == "PNM",
wv %in% WLs) %>%
group_by(wv) %>% summarise(value = mean(value),
.groups = "drop") %>% dplyr::select(value)
data.spectra_L_FTS <- data.spectra %>% filter(GF == "Liana",
site == "FTS",
wv %in% WLs) %>%
group_by(wv) %>% summarise(value = mean(value),
.groups = "drop") %>% dplyr::select(value)
GFs <- c('Tree','Liana')
sites <- c('PNM','FTS')
maxNspecies <- Inf
maxNind <- Inf
array_obs_reflectance <- array(data = NA, dim = c(Nwl,2,2,30,15,3))
Nspecies <- array(data = NA, dim = c(2,2))
Nind <- array(data = NA, dim = c(2,2,30))
maxNspecies <- max(Nspecies,na.rm = TRUE)
maxNind <- max(Nind,na.rm = TRUE)
Nspecies
maxNspecies <- Inf
maxNind <- Inf
array_obs_reflectance <- array(data = NA, dim = c(Nwl,2,2,30,15,3))
Nspecies <- array(data = NA, dim = c(2,2))
Nind <- array(data = NA, dim = c(2,2,30))
for (iGF in seq(1,length(GFs))){
for (isite in seq(1,length(sites))){
cdata <- data.spectra %>% filter(GF == GFs[iGF],
site == sites[isite])
Nspecies[iGF,isite] <- min(maxNspecies,length(unique(cdata$species.id)))
for (ispecies in seq(1,Nspecies[iGF,isite])){
ccdata <- cdata %>% filter(species.id == ispecies)
Nind[iGF,isite,ispecies] <- min(maxNind,length(unique(ccdata$ind.id)))
for (iind in seq(1, Nind[iGF,isite,ispecies])){
cccdata <- ccdata %>% filter(ind.id == iind)
array_obs_reflectance[,iGF,isite,ispecies,iind,1] <- cccdata %>% filter(name == 1) %>% filter(wv %in% WLs) %>% arrange(wv) %>% pull(value)
array_obs_reflectance[,iGF,isite,ispecies,iind,2] <- cccdata %>% filter(name == 2) %>% filter(wv %in% WLs) %>% arrange(wv) %>% pull(value)
array_obs_reflectance[,iGF,isite,ispecies,iind,3] <- cccdata %>% filter(name == 3) %>% filter(wv %in% WLs) %>% arrange(wv) %>% pull(value)
}
}
}
}
maxNspecies <- max(Nspecies,na.rm = TRUE)
maxNind <- max(Nind,na.rm = TRUE)
Data <- list(obs_reflectance = cbind(data.spectra_T_PNM,
data.spectra_T_FTS,
data.spectra_L_PNM,
data.spectra_L_FTS))
colnames(Data$obs_reflectance) <- NULL
par(mfrow = c(1,1))
matplot(WLs,Data$obs_reflectance[,1:2],type = 'l',col = "darkgreen") # Trees
matlines(WLs,Data$obs_reflectance[,3:4],type = 'l',col = "darkblue") # Lianas
Constants <- list(Nwl = Nwl,
talf = rrtm:::p45_talf[pos],
t12 = rrtm:::p45_t12[pos],
t21 = rrtm:::p45_t21[pos],
dataspec_p5 = rrtm:::dataspec_p5[pos,1:5])
Inits <- list(Nmean = 2,
Cabmean = 40,
Carmean = 10,
Cwmean = 0.01,
Cmmean = 0.01,
Standard.Dev = 0.05,
alpha_N = 0,
alpha_Cab = 0,
alpha_Car = 0,
alpha_Cw = 0,
alpha_Cm = 0,
alpha_SD = 0)
P5model <- nimbleModel(run_prospect5,
dimensions = list(dataspec_p5 = c(Nwl,5),
talf = Nwl,
t12 = Nwl,
t21 = Nwl,
reflectance_T_PNM = c(Nwl),
reflectance_T_FTS = c(Nwl),
reflectance_L_PNM = c(Nwl),
reflectance_L_FTS = c(Nwl),
creflectance = c(Nwl,4)),
data = Data,
constants = Constants,
debug = FALSE,
inits = Inits)
P5model$initializeInfo()
Nchains = 2
mcmc.out <- nimbleMCMC(code = P5model,
constants = Constants,
monitors = c("Nmean","Cabmean","Carmean","Cwmean","Cmmean","Standard.Dev",
"alpha_N","alpha_Cab","alpha_Car","alpha_Cw","alpha_Cm","alpha_SD"),
data = Data,
inits = Inits,
nburnin = 5000,
nchains = Nchains,
niter = 15000,
summary = TRUE,
WAIC = FALSE,
samplesAsCodaMCMC = TRUE)
MCMCsamples <- mcmc.out$samples
param <- MCMCsamples[,1:12]
param_X = 5
plot(param[,c(0,6) + param_X])
array_mod_reflectance <- array(data = NA, dim = c(dim(array_obs_reflectance)[1:5],Nsimu))
Nsimu <- 1000
if (Nchains == 1){
pos.simu <- sample(1:nrow(MCMCsamples),Nsimu)
param_all <- MCMCsamples[pos.simu,1:12]
} else {
pos.simu <- sample(1:nrow(MCMCsamples[[1]]),Nsimu)
param_all <- do.call(rbind,lapply(1:Nchains,function(i) MCMCsamples[[i]][pos.simu,1:12]))
}
array_mod_reflectance <- array(data = NA, dim = c(dim(array_obs_reflectance)[1:5],Nsimu))
all_N <- all_Cab <- all_Car <- all_Cw <- all_Cm <- array(data = NA, dim = c(dim(array_obs_reflectance)[2:5],Nsimu),dimnames = list(c("Tree","Liana"),
c("PNM","FTS"),
seq(1,30),
seq(1:15),
seq(1:Nsimu)))
for(iGF in 1:NGF){
for (isite in 1:Nsite[iGF]){
for (ispecies in 1:Nspecies[iGF,isite]){
for (iind in 1:Nind[iGF,isite,ispecies]){
cN <- param_all[,"mean_N"] + (iGF - 1)*param_all[,"alpha_N"] + (isite - 1)*param_all[,paste0("beta_N[",iGF,"]")] +
param_all[,paste0("gamma_N[",iGF,", ",isite,", ",ispecies,"]")] + param_all[,paste0("delta_N[",iGF,", ",isite,", ",ispecies,", ",iind,"]")]
all_N[iGF,isite,ispecies,iind,] <- cN
cCab <- param_all[,"mean_Cab"] + (iGF - 1)*param_all[,"alpha_Cab"] + (isite - 1)*param_all[,paste0("beta_Cab[",iGF,"]")] +
param_all[,paste0("gamma_Cab[",iGF,", ",isite,", ",ispecies,"]")] + param_all[,paste0("delta_Cab[",iGF,", ",isite,", ",ispecies,", ",iind,"]")]
all_Cab[iGF,isite,ispecies,iind,] <- cCab
cCar <- param_all[,"mean_Car"] + (iGF - 1)*param_all[,"alpha_Car"] + (isite - 1)*param_all[,paste0("beta_Car[",iGF,"]")] +
param_all[,paste0("gamma_Car[",iGF,", ",isite,", ",ispecies,"]")] + param_all[,paste0("delta_Car[",iGF,", ",isite,", ",ispecies,", ",iind,"]")]
all_Car[iGF,isite,ispecies,iind,] <- cCar
cCw <- param_all[,"mean_Cw"] + (iGF - 1)*param_all[,"alpha_Cw"] + (isite - 1)*param_all[,paste0("beta_Cw[",iGF,"]")] +
param_all[,paste0("gamma_Cw[",iGF,", ",isite,", ",ispecies,"]")] + param_all[,paste0("delta_Cw[",iGF,", ",isite,", ",ispecies,", ",iind,"]")]
all_Cw[iGF,isite,ispecies,iind,] <- cCw
cCm <- param_all[,"mean_Cm"] + (iGF - 1)*param_all[,"alpha_Cm"] + (isite - 1)*param_all[,paste0("beta_Cm[",iGF,"]")] +
param_all[,paste0("gamma_Cm[",iGF,", ",isite,", ",ispecies,"]")] + param_all[,paste0("delta_Cm[",iGF,", ",isite,", ",ispecies,", ",iind,"]")]
all_Cm[iGF,isite,ispecies,iind,] <- cCm
tmp <- matrix(unlist(lapply(1:Nsimu,function(ileaf){
rrtm::prospect5(N = cN[ileaf],
Cab = cCab[ileaf],
Car = cCar[ileaf],
Cbrown = 0,
Cw = cCw[ileaf],
Cm = cCm[ileaf])[["reflectance"]][pos]})),ncol = Nsimu)
array_mod_reflectance[,iGF,isite,ispecies,iind,] <- tmp
# matplot(WLs,tmp[,1:Nsimu],type = 'l',col = "black")
# matlines(WLs,Data$obs_reflectance[,iGF,isite,ispecies,iind,],col = "red")
# lines(WLs,apply(Data$obs_reflectance[,iGF,isite,ispecies,iind,],1,mean),col = "red",lwd = 2)
}
}
}
}
all_N <- all_Cab <- all_Car <- all_Cw <- all_Cm <- array(data = NA, dim = c(dim(array_obs_reflectance)[2:5],Nsimu),dimnames = list(c("Tree","Liana"),
c("PNM","FTS"),
seq(1,30),
seq(1:15),
seq(1:Nsimu)))
NGF
NGF = 2
Nsite
Nsite <- c(2,2)
Nspecies
Nind
for(iGF in 1:NGF){
for (isite in 1:Nsite[iGF]){
for (ispecies in 1:Nspecies[iGF,isite]){
for (iind in 1:Nind[iGF,isite,ispecies]){
cN <- param_all[,"mean_N"] + (iGF - 1)*param_all[,"alpha_N"] + (isite - 1)*param_all[,paste0("beta_N[",iGF,"]")] +
param_all[,paste0("gamma_N[",iGF,", ",isite,", ",ispecies,"]")] + param_all[,paste0("delta_N[",iGF,", ",isite,", ",ispecies,", ",iind,"]")]
all_N[iGF,isite,ispecies,iind,] <- cN
cCab <- param_all[,"mean_Cab"] + (iGF - 1)*param_all[,"alpha_Cab"] + (isite - 1)*param_all[,paste0("beta_Cab[",iGF,"]")] +
param_all[,paste0("gamma_Cab[",iGF,", ",isite,", ",ispecies,"]")] + param_all[,paste0("delta_Cab[",iGF,", ",isite,", ",ispecies,", ",iind,"]")]
all_Cab[iGF,isite,ispecies,iind,] <- cCab
cCar <- param_all[,"mean_Car"] + (iGF - 1)*param_all[,"alpha_Car"] + (isite - 1)*param_all[,paste0("beta_Car[",iGF,"]")] +
param_all[,paste0("gamma_Car[",iGF,", ",isite,", ",ispecies,"]")] + param_all[,paste0("delta_Car[",iGF,", ",isite,", ",ispecies,", ",iind,"]")]
all_Car[iGF,isite,ispecies,iind,] <- cCar
cCw <- param_all[,"mean_Cw"] + (iGF - 1)*param_all[,"alpha_Cw"] + (isite - 1)*param_all[,paste0("beta_Cw[",iGF,"]")] +
param_all[,paste0("gamma_Cw[",iGF,", ",isite,", ",ispecies,"]")] + param_all[,paste0("delta_Cw[",iGF,", ",isite,", ",ispecies,", ",iind,"]")]
all_Cw[iGF,isite,ispecies,iind,] <- cCw
cCm <- param_all[,"mean_Cm"] + (iGF - 1)*param_all[,"alpha_Cm"] + (isite - 1)*param_all[,paste0("beta_Cm[",iGF,"]")] +
param_all[,paste0("gamma_Cm[",iGF,", ",isite,", ",ispecies,"]")] + param_all[,paste0("delta_Cm[",iGF,", ",isite,", ",ispecies,", ",iind,"]")]
all_Cm[iGF,isite,ispecies,iind,] <- cCm
tmp <- matrix(unlist(lapply(1:Nsimu,function(ileaf){
rrtm::prospect5(N = cN[ileaf],
Cab = cCab[ileaf],
Car = cCar[ileaf],
Cbrown = 0,
Cw = cCw[ileaf],
Cm = cCm[ileaf])[["reflectance"]][pos]})),ncol = Nsimu)
array_mod_reflectance[,iGF,isite,ispecies,iind,] <- tmp
# matplot(WLs,tmp[,1:Nsimu],type = 'l',col = "black")
# matlines(WLs,Data$obs_reflectance[,iGF,isite,ispecies,iind,],col = "red")
# lines(WLs,apply(Data$obs_reflectance[,iGF,isite,ispecies,iind,],1,mean),col = "red",lwd = 2)
}
}
}
}
seq(1:Nsimu)))
all_N <- all_Cab <- all_Car <- all_Cw <- all_Cm <- array(data = NA, dim = c(dim(array_obs_reflectance)[2:5],Nsimu),dimnames = list(c("Tree","Liana"),
c("PNM","FTS"),
seq(1,30),
seq(1:15),
seq(1:Nsimu)))
NGF <- 2
Nsite <- c(2,2)
NGF <- 2
Nsite <- c(2,2)
for(iGF in 1:NGF){
for (isite in 1:Nsite[iGF]){
for (ispecies in 1:Nspecies[iGF,isite]){
for (iind in 1:Nind[iGF,isite,ispecies]){
cN <- param_all[,"Nmean"] + (iGF - 1)*param_all[,"alpha_N"]
all_N[iGF,isite,ispecies,iind,] <- cN
cCab <- param_all[,"Cabmean"] + (iGF - 1)*param_all[,"alpha_Cab"]
all_Cab[iGF,isite,ispecies,iind,] <- cCab
cCar <- param_all[,"Carmean"] + (iGF - 1)*param_all[,"alpha_Car"]
all_Car[iGF,isite,ispecies,iind,] <- cCar
cCw <- param_all[,"Cwmean"] + (iGF - 1)*param_all[,"alpha_Cw"]
all_Cw[iGF,isite,ispecies,iind,] <- cCw
cCm <- param_all[,"Cmmean"] + (iGF - 1)*param_all[,"alpha_Cm"]
all_Cm[iGF,isite,ispecies,iind,] <- cCm
tmp <- matrix(unlist(lapply(1:Nsimu,function(ileaf){
rrtm::prospect5(N = cN[ileaf],
Cab = cCab[ileaf],
Car = cCar[ileaf],
Cbrown = 0,
Cw = cCw[ileaf],
Cm = cCm[ileaf])[["reflectance"]][pos]})),ncol = Nsimu)
array_mod_reflectance[,iGF,isite,ispecies,iind,] <- tmp
# matplot(WLs,tmp[,1:Nsimu],type = 'l',col = "black")
# matlines(WLs,Data$obs_reflectance[,iGF,isite,ispecies,iind,],col = "red")
# lines(WLs,apply(Data$obs_reflectance[,iGF,isite,ispecies,iind,],1,mean),col = "red",lwd = 2)
}
}
}
}
cN
dim(param_all)
pos.simu
Nsimu
sample(1:(Nchains*nrow(MCMCsamples[[1]])),Nsimu)
if (Nchains == 1){
pos.simu <- sample(1:nrow(MCMCsamples),Nsimu)
param_all <- MCMCsamples[pos.simu,1:12]
} else {
pos.simu <- sample(1:nrow(MCMCsamples[[1]]),Nsimu)
param_all <- do.call(rbind,lapply(1:Nchains,function(i) MCMCsamples[[i]][pos.simu,1:12]))[sample(1:(Nchains*nrow(MCMCsamples[[1]])),Nsimu)]
}
array_mod_reflectance <- array(data = NA, dim = c(dim(array_obs_reflectance)[1:5],Nsimu))
all_N <- all_Cab <- all_Car <- all_Cw <- all_Cm <- array(data = NA, dim = c(dim(array_obs_reflectance)[2:5],Nsimu),dimnames = list(c("Tree","Liana"),
c("PNM","FTS"),
seq(1,30),
seq(1:15),
seq(1:Nsimu)))
NGF <- 2
Nsite <- c(2,2)
for(iGF in 1:NGF){
for (isite in 1:Nsite[iGF]){
for (ispecies in 1:Nspecies[iGF,isite]){
for (iind in 1:Nind[iGF,isite,ispecies]){
cN <- param_all[,"Nmean"] + (iGF - 1)*param_all[,"alpha_N"]
all_N[iGF,isite,ispecies,iind,] <- cN
cCab <- param_all[,"Cabmean"] + (iGF - 1)*param_all[,"alpha_Cab"]
all_Cab[iGF,isite,ispecies,iind,] <- cCab
cCar <- param_all[,"Carmean"] + (iGF - 1)*param_all[,"alpha_Car"]
all_Car[iGF,isite,ispecies,iind,] <- cCar
cCw <- param_all[,"Cwmean"] + (iGF - 1)*param_all[,"alpha_Cw"]
all_Cw[iGF,isite,ispecies,iind,] <- cCw
cCm <- param_all[,"Cmmean"] + (iGF - 1)*param_all[,"alpha_Cm"]
all_Cm[iGF,isite,ispecies,iind,] <- cCm
tmp <- matrix(unlist(lapply(1:Nsimu,function(ileaf){
rrtm::prospect5(N = cN[ileaf],
Cab = cCab[ileaf],
Car = cCar[ileaf],
Cbrown = 0,
Cw = cCw[ileaf],
Cm = cCm[ileaf])[["reflectance"]][pos]})),ncol = Nsimu)
array_mod_reflectance[,iGF,isite,ispecies,iind,] <- tmp
# matplot(WLs,tmp[,1:Nsimu],type = 'l',col = "black")
# matlines(WLs,Data$obs_reflectance[,iGF,isite,ispecies,iind,],col = "red")
# lines(WLs,apply(Data$obs_reflectance[,iGF,isite,ispecies,iind,],1,mean),col = "red",lwd = 2)
}
}
}
}
param_all[,"Nmean"]
param_all
Nsimu <- 1000
if (Nchains == 1){
pos.simu <- sample(1:nrow(MCMCsamples),Nsimu)
param_all <- MCMCsamples[pos.simu,1:12]
} else {
pos.simu <- sample(1:nrow(MCMCsamples[[1]]),Nsimu)
param_all <- do.call(rbind,lapply(1:Nchains,function(i) MCMCsamples[[i]][pos.simu,1:12]))[sample(1:(Nchains*nrow(MCMCsamples[[1]])),Nsimu),]
}
array_mod_reflectance <- array(data = NA, dim = c(dim(array_obs_reflectance)[1:5],Nsimu))
all_N <- all_Cab <- all_Car <- all_Cw <- all_Cm <- array(data = NA, dim = c(dim(array_obs_reflectance)[2:5],Nsimu),dimnames = list(c("Tree","Liana"),
c("PNM","FTS"),
seq(1,30),
seq(1:15),
seq(1:Nsimu)))
NGF <- 2
do.call(rbind,lapply(1:Nchains,function(i) MCMCsamples[[i]][pos.simu,1:12]))[
do.call(rbind,lapply(1:Nchains,function(i) MCMCsamples[[i]][pos.simu,1:12]))
param_all <- do.call(rbind,lapply(1:Nchains,function(i) MCMCsamples[[i]][pos.simu,1:12]))[sample(1:(Nchains*nrow(MCMCsamples[[1]])),Nsimu),]
param_all <- do.call(rbind,lapply(1:Nchains,function(i) MCMCsamples[[i]][pos.simu,1:12]))[sample(1:(Nchains*Nsimu),Nsimu),]
param_all
hist(param_all[,1])
array_mod_reflectance <- array(data = NA, dim = c(dim(array_obs_reflectance)[1:5],Nsimu))
all_N <- all_Cab <- all_Car <- all_Cw <- all_Cm <- array(data = NA, dim = c(dim(array_obs_reflectance)[2:5],Nsimu),dimnames = list(c("Tree","Liana"),
c("PNM","FTS"),
seq(1,30),
seq(1:15),
seq(1:Nsimu)))
NGF <- 2
Nsite <- c(2,2)
for(iGF in 1:NGF){
for (isite in 1:Nsite[iGF]){
for (ispecies in 1:Nspecies[iGF,isite]){
for (iind in 1:Nind[iGF,isite,ispecies]){
cN <- param_all[,"Nmean"] + (iGF - 1)*param_all[,"alpha_N"]
all_N[iGF,isite,ispecies,iind,] <- cN
cCab <- param_all[,"Cabmean"] + (iGF - 1)*param_all[,"alpha_Cab"]
all_Cab[iGF,isite,ispecies,iind,] <- cCab
cCar <- param_all[,"Carmean"] + (iGF - 1)*param_all[,"alpha_Car"]
all_Car[iGF,isite,ispecies,iind,] <- cCar
cCw <- param_all[,"Cwmean"] + (iGF - 1)*param_all[,"alpha_Cw"]
all_Cw[iGF,isite,ispecies,iind,] <- cCw
cCm <- param_all[,"Cmmean"] + (iGF - 1)*param_all[,"alpha_Cm"]
all_Cm[iGF,isite,ispecies,iind,] <- cCm
tmp <- matrix(unlist(lapply(1:Nsimu,function(ileaf){
rrtm::prospect5(N = cN[ileaf],
Cab = cCab[ileaf],
Car = cCar[ileaf],
Cbrown = 0,
Cw = cCw[ileaf],
Cm = cCm[ileaf])[["reflectance"]][pos]})),ncol = Nsimu)
array_mod_reflectance[,iGF,isite,ispecies,iind,] <- tmp
# matplot(WLs,tmp[,1:Nsimu],type = 'l',col = "black")
# matlines(WLs,Data$obs_reflectance[,iGF,isite,ispecies,iind,],col = "red")
# lines(WLs,apply(Data$obs_reflectance[,iGF,isite,ispecies,iind,],1,mean),col = "red",lwd = 2)
}
}
}
}
NGF <- 2
Nsite <- c(2,2)
for(iGF in 1:NGF){
for (isite in 1:Nsite[iGF]){
print(c(iGF,isite))
for (ispecies in 1:Nspecies[iGF,isite]){
for (iind in 1:Nind[iGF,isite,ispecies]){
cN <- param_all[,"Nmean"] + (iGF - 1)*param_all[,"alpha_N"]
all_N[iGF,isite,ispecies,iind,] <- cN
cCab <- param_all[,"Cabmean"] + (iGF - 1)*param_all[,"alpha_Cab"]
all_Cab[iGF,isite,ispecies,iind,] <- cCab
cCar <- param_all[,"Carmean"] + (iGF - 1)*param_all[,"alpha_Car"]
all_Car[iGF,isite,ispecies,iind,] <- cCar
cCw <- param_all[,"Cwmean"] + (iGF - 1)*param_all[,"alpha_Cw"]
all_Cw[iGF,isite,ispecies,iind,] <- cCw
cCm <- param_all[,"Cmmean"] + (iGF - 1)*param_all[,"alpha_Cm"]
all_Cm[iGF,isite,ispecies,iind,] <- cCm
tmp <- matrix(unlist(lapply(1:Nsimu,function(ileaf){
rrtm::prospect5(N = cN[ileaf],
Cab = cCab[ileaf],
Car = cCar[ileaf],
Cbrown = 0,
Cw = cCw[ileaf],
Cm = cCm[ileaf])[["reflectance"]][pos]})),ncol = Nsimu)
array_mod_reflectance[,iGF,isite,ispecies,iind,] <- tmp
# matplot(WLs,tmp[,1:Nsimu],type = 'l',col = "black")
# matlines(WLs,Data$obs_reflectance[,iGF,isite,ispecies,iind,],col = "red")
# lines(WLs,apply(Data$obs_reflectance[,iGF,isite,ispecies,iind,],1,mean),col = "red",lwd = 2)
}
}
}
}
Nsimu <- 100
if (Nchains == 1){
pos.simu <- sample(1:nrow(MCMCsamples),Nsimu)
param_all <- MCMCsamples[pos.simu,1:12]
} else {
pos.simu <- sample(1:nrow(MCMCsamples[[1]]),Nsimu)
param_all <- do.call(rbind,lapply(1:Nchains,function(i) MCMCsamples[[i]][pos.simu,1:12]))[sample(1:(Nchains*Nsimu),Nsimu),]
}
array_mod_reflectance <- array(data = NA, dim = c(dim(array_obs_reflectance)[1:5],Nsimu))
all_N <- all_Cab <- all_Car <- all_Cw <- all_Cm <- array(data = NA, dim = c(dim(array_obs_reflectance)[2:5],Nsimu),dimnames = list(c("Tree","Liana"),
c("PNM","FTS"),
seq(1,30),
seq(1:15),
seq(1:Nsimu)))
NGF <- 2
Nsite <- c(2,2)
for(iGF in 1:NGF){
for (isite in 1:Nsite[iGF]){
print(c(iGF,isite))
for (ispecies in 1:Nspecies[iGF,isite]){
for (iind in 1:Nind[iGF,isite,ispecies]){
cN <- param_all[,"Nmean"] + (iGF - 1)*param_all[,"alpha_N"]
all_N[iGF,isite,ispecies,iind,] <- cN
cCab <- param_all[,"Cabmean"] + (iGF - 1)*param_all[,"alpha_Cab"]
all_Cab[iGF,isite,ispecies,iind,] <- cCab
cCar <- param_all[,"Carmean"] + (iGF - 1)*param_all[,"alpha_Car"]
all_Car[iGF,isite,ispecies,iind,] <- cCar
cCw <- param_all[,"Cwmean"] + (iGF - 1)*param_all[,"alpha_Cw"]
all_Cw[iGF,isite,ispecies,iind,] <- cCw
cCm <- param_all[,"Cmmean"] + (iGF - 1)*param_all[,"alpha_Cm"]
all_Cm[iGF,isite,ispecies,iind,] <- cCm
tmp <- matrix(unlist(lapply(1:Nsimu,function(ileaf){
rrtm::prospect5(N = cN[ileaf],
Cab = cCab[ileaf],
Car = cCar[ileaf],
Cbrown = 0,
Cw = cCw[ileaf],
Cm = cCm[ileaf])[["reflectance"]][pos]})),ncol = Nsimu)
array_mod_reflectance[,iGF,isite,ispecies,iind,] <- tmp
# matplot(WLs,tmp[,1:Nsimu],type = 'l',col = "black")
# matlines(WLs,Data$obs_reflectance[,iGF,isite,ispecies,iind,],col = "red")
# lines(WLs,apply(Data$obs_reflectance[,iGF,isite,ispecies,iind,],1,mean),col = "red",lwd = 2)
}
}
}
}
for(iGF in 1:NGF){
for (isite in 1:Nsite[iGF]){
for (ispecies in 1:Nspecies[iGF,isite]){
print(c(iGF,isite,ispecies))
for (iind in 1:Nind[iGF,isite,ispecies]){
cN <- param_all[,"Nmean"] + (iGF - 1)*param_all[,"alpha_N"]
all_N[iGF,isite,ispecies,iind,] <- cN
cCab <- param_all[,"Cabmean"] + (iGF - 1)*param_all[,"alpha_Cab"]
all_Cab[iGF,isite,ispecies,iind,] <- cCab
cCar <- param_all[,"Carmean"] + (iGF - 1)*param_all[,"alpha_Car"]
all_Car[iGF,isite,ispecies,iind,] <- cCar
cCw <- param_all[,"Cwmean"] + (iGF - 1)*param_all[,"alpha_Cw"]
all_Cw[iGF,isite,ispecies,iind,] <- cCw
cCm <- param_all[,"Cmmean"] + (iGF - 1)*param_all[,"alpha_Cm"]
all_Cm[iGF,isite,ispecies,iind,] <- cCm
tmp <- matrix(unlist(lapply(1:Nsimu,function(ileaf){
rrtm::prospect5(N = cN[ileaf],
Cab = cCab[ileaf],
Car = cCar[ileaf],
Cbrown = 0,
Cw = cCw[ileaf],
Cm = cCm[ileaf])[["reflectance"]][pos]})),ncol = Nsimu)
array_mod_reflectance[,iGF,isite,ispecies,iind,] <- tmp
# matplot(WLs,tmp[,1:Nsimu],type = 'l',col = "black")
# matlines(WLs,Data$obs_reflectance[,iGF,isite,ispecies,iind,],col = "red")
# lines(WLs,apply(Data$obs_reflectance[,iGF,isite,ispecies,iind,],1,mean),col = "red",lwd = 2)
}
}
}
}
head(array_mod_reflectance)
dim(array_mod_reflectance)
# Individual level
Y <- as.vector(apply(array_obs_reflectance,c(1,2,3,4,5),mean))
X <- as.vector(apply(array_mod_reflectance,c(1,2,3,4,5),mean))
plot(X,Y)
abline(a = 0, b = 1, col ='red')
LM <- lm(data.frame(x = X,y = Y),formula = y ~ x)
summary(LM)
anovobj<-aov(LM)
allssq<-summary(anovobj)[[1]][,2]
allssq
sqrt(c(crossprod(LM$residuals))/length(LM$residuals))
# GF/site level
Y <- as.vector(apply(array_obs_reflectance,c(1,2,3),mean,na.rm = TRUE))
X <- as.vector(apply(array_mod_reflectance,c(1,2,3),mean,na.rm = TRUE))
plot(X,Y)
abline(a = 0, b = 1, col ='red')
LM <- lm(data.frame(x = X,y = Y),formula = y ~ x)
summary(LM)
anovobj<-aov(LM)
allssq<-summary(anovobj)[[1]][,2]
allssq
41*8.6
